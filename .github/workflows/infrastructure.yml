name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev

env:
  AZURE_RESOURCE_GROUP: 'rg-recipe-app-${{ github.event.inputs.environment }}'
  AZURE_LOCATION: 'northeurope'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    outputs:
      container-app-url: ${{ steps.bicep-deploy.outputs.containerAppUrl }}
      static-web-app-url: ${{ steps.bicep-deploy.outputs.staticWebAppUrl }}
      key-vault-name: ${{ steps.bicep-deploy.outputs.keyVaultName }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }}
    
    - name: Deploy Bicep
      id: bicep-deploy
      uses: azure/arm-deploy@v1
      with:
        scope: resourcegroup
        resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
        template: ./infrastructure/main.bicep
        parameters: >
          environment=${{ github.event.inputs.environment }}
          sqlAdminUsername=${{ secrets.SQL_ADMIN_USERNAME }}
          sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
          azureOpenAIEndpoint=${{ secrets.AZURE_OPENAI_ENDPOINT }}
          azureOpenAIKey=${{ secrets.AZURE_OPENAI_KEY }}
          azureOpenAIDeploymentName=${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}
        failOnStdErr: false
    
    - name: Display deployment info
      run: |
        echo "âœ… Infrastructure deployed successfully!"
        echo "ğŸ” Key Vault: ${{ steps.bicep-deploy.outputs.keyVaultName }}"
        echo "ğŸ”— Backend API: ${{ steps.bicep-deploy.outputs.containerAppUrl }}"
        echo "ğŸ”— Frontend: ${{ steps.bicep-deploy.outputs.staticWebAppUrl }}"
